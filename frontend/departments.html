<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ุงูุฃูุงุฏูููุฉ - ุฅุถุงูุฉ ูุชุนุฏูู ุฃูุณุงู ุงููููุฉ">
  <title>ุฅุฏุงุฑุฉ ุงูุฃูุณุงู - ูููุฏ ุงูุฌุฏูู ุงูุฏุฑุงุณู</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <!-- Preload critical resources -->
  <link rel="preload" href="js/shared.js" as="script">
  <link rel="preload" href="js/departments.js" as="script">
</head>
<body>
  <div class="loading-overlay hidden" id="globalLoader">
    <div class="loading-spinner"></div>
    <div class="loading-text">ุฌุงุฑ ุงูุชุญููู...</div>
  </div>

  <nav class="main-nav animate__animated animate__fadeIn" aria-label="ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ">
    <ul>
      <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
      <li><a href="settings.html">ุฅุนุฏุงุฏุงุช ุงููููุฉ</a></li>
      <li><a href="departments.html" class="active" aria-current="page">ุฅุฏุงุฑุฉ ุงูุฃูุณุงู</a></li>
      <li><a href="add-teachers.html">ุฅุถุงูุฉ ูุฏุฑุณูู</a></li>
      <li><a href="students.html">ุฅุฏุงุฑุฉ ุงูุทูุงุจ</a></li>
      <li><a href="courses.html">ุฅุฏุงุฑุฉ ุงูููุงุฏ</a></li>
      <li><a href="rooms.html">ุฅุฏุงุฑุฉ ุงูุฃูุงูู</a></li>
      <li><a href="teachers.html">ุฅุฏุงุฑุฉ ุงููุฏุฑุณูู</a></li>
      <li><a href="generate.html">ุชูููุฏ ุงูุฌุฏูู</a></li>
      <li><a href="schedule.html">ุนุฑุถ ุงูุฌุฏูู</a></li>
    </ul>
  </nav>

  <main class="container animate__animated animate__fadeIn">
    <header>
      <h1 class="animate__animated animate__bounceIn">ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ุงูุฃูุงุฏูููุฉ</h1>
      <p class="subtitle">ุฅุถุงูุฉ ูุชุนุฏูู ุงูุฃูุณุงู ุงูุฏุฑุงุณูุฉ ุจุงููููุฉ</p>
    </header>

    <section class="section animate-slide" aria-labelledby="add-dept-heading">
      <h2 id="add-dept-heading">ุฅุถุงูุฉ ูุณู ุฌุฏูุฏ</h2>
      <form id="departmentForm" class="form-grid">
        <div class="input-group">
          <label for="deptName">ุงุณู ุงููุณู:</label>
          <input type="text" id="deptName" placeholder="ุงุณู ุงููุณู ุจุงููุงูู" required
                 aria-describedby="deptNameHelp" aria-required="true">
          <p id="deptNameHelp" class="input-hint">ูุฌุจ ุฃู ูููู ุงุณู ุงููุณู ูุงุถุญุงู ููููุฒุงู</p>
        </div>
        
        <div class="input-group">
          <label for="deptCode">ููุฏ ุงููุณู:</label>
          <input type="text" id="deptCode" placeholder="ูุซุงู: CS, MATH" maxlength="6" 
                 style="text-transform: uppercase" required aria-describedby="deptCodeHelp"
                 aria-required="true">
          <p id="deptCodeHelp" class="input-hint">2-6 ุฃุญุฑู ุฅูุฌููุฒูุฉ (ุณูุชู ุชุญููููุง ูุญุฑูู ูุจูุฑุฉ)</p>
        </div>
        
        <div class="input-group">
          <label for="deptColor">ููู ุงููุณู:</label>
          <div class="color-picker-container">
            <input type="color" id="deptColor" value="#8e44ad" aria-describedby="deptColorHelp">
            <span id="colorPreview" class="color-preview" style="background-color: #8e44ad" 
                  aria-hidden="true"></span>
          </div>
          <p id="deptColorHelp" class="input-hint">ุงุฎุชุฑ ูููุงู ูููุฒ ุงููุณู ูู ุงูุฌุฏูู</p>
        </div>

        <div class="form-actions">
          <button type="submit" id="addDeptBtn" class="btn-primary">
            <span class="icon">โ</span>
            <span class="text" id="submitBtnText">ุฅุถุงูุฉ ูุณู</span>
          </button>
          <button type="button" id="clearFormBtn" class="btn-accent">
            <span class="icon">๐๏ธ</span>
            <span class="text">ูุณุญ ุงููููุฐุฌ</span>
          </button>
          <button type="button" id="cancelEditBtn" class="btn-accent hidden">
            <span class="icon">โ๏ธ</span>
            <span class="text">ุฅูุบุงุก ุงูุชุนุฏูู</span>
          </button>
        </div>
      </form>
    </section>

    <section class="section animate-slide" aria-labelledby="dept-stats-heading">
      <h2 id="dept-stats-heading">ุฅุญุตุงุฆูุงุช ุงูุฃูุณุงู</h2>
      <div class="stats-summary">
        <div class="stat-card">
          <div class="stat-icon">๐๏ธ</div>
          <h3>ุนุฏุฏ ุงูุฃูุณุงู</h3>
          <p id="deptCount" aria-live="polite">0</p>
        </div>
        <div class="stat-card">
          <div class="stat-icon">๐จโ๐ซ</div>
          <h3>ุนุฏุฏ ุงููุฏุฑุณูู</h3>
          <p id="teacherCount" aria-live="polite">0</p>
        </div>
        <div class="stat-card">
          <div class="stat-icon">๐ซ</div>
          <h3>ุนุฏุฏ ุงููุงุนุงุช</h3>
          <p id="roomCount" aria-live="polite">0</p>
        </div>
        <div class="stat-card">
          <div class="stat-icon">๐ฌ</div>
          <h3>ุนุฏุฏ ุงููุนุงูู</h3>
          <p id="labCount" aria-live="polite">0</p>
        </div>
      </div>
    </section>

    <section class="section animate-slide" aria-labelledby="dept-list-heading">
      <div class="section-header">
        <h2 id="dept-list-heading">ูุงุฆูุฉ ุงูุฃูุณุงู</h2>
        <div class="section-actions">
          <div class="search-container">
            <label for="deptSearch" class="sr-only">ุจุญุซ ุงูุฃูุณุงู</label>
            <input type="text" id="deptSearch" placeholder="ุงุจุญุซ ุนู ูุณู..." aria-label="ุจุญุซ ุงูุฃูุณุงู">
            <span class="search-icon">๐</span>
          </div>
          <button id="exportDeptsBtn" class="btn-small btn-secondary" aria-label="ุชุตุฏูุฑ ุงูุฃูุณุงู">
            <span class="icon">๐ค</span>
            <span class="text">ุชุตุฏูุฑ</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-responsive">
          <table id="departmentsTable" class="data-table" aria-describedby="dept-list-heading">
            <thead>
              <tr>
                <th scope="col" width="30%">ุงุณู ุงููุณู</th>
                <th scope="col" width="15%">ููุฏ ุงููุณู</th>
                <th scope="col" width="15%">ุงููุฏุฑุณูู</th>
                <th scope="col" width="15%">ุงููุงุนุงุช</th>
                <th scope="col" width="15%">ุงููุนุงูู</th>
                <th scope="col" width="10%">ุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody>
              <!-- Will be populated by JavaScript -->
              <tr class="empty-row">
                <td colspan="6">
                  <div class="empty-table-message">
                    <p>ูุง ุชูุฌุฏ ุฃูุณุงู ูุณุฌูุฉ ุจุนุฏ</p>
                    <button id="addSampleDepts" class="btn-small btn-secondary" aria-label="ุฅุถุงูุฉ ุฃูุณุงู ูููุฐุฌูุฉ">
                      ุฅุถุงูุฉ ุฃูุณุงู ูููุฐุฌูุฉ
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="table-footer">
        <div class="table-info" id="tableInfo">
          ุนุฑุถ <span id="currentCount">0</span> ูู <span id="totalCount">0</span> ูุณู
        </div>
        <div class="pagination">
          <button id="prevPage" class="pagination-btn" disabled aria-label="ุงูุตูุญุฉ ุงูุณุงุจูุฉ">
            <span class="icon">โถ</span>
          </button>
          <span id="pageInfo">ุงูุตูุญุฉ 1</span>
          <button id="nextPage" class="pagination-btn" disabled aria-label="ุงูุตูุญุฉ ุงูุชุงููุฉ">
            <span class="icon">โ</span>
          </button>
        </div>
      </div>
    </section>
  </main>

  <footer class="main-footer">
    <p>ูุธุงู ุชูููุฏ ุงูุฌุฏุงูู ุงูุฏุฑุงุณูุฉ &copy; <span id="currentYear"></span></p>
  </footer>

  <!-- Department Actions Context Menu -->
  <div id="contextMenu" class="context-menu hidden" aria-hidden="true">
    <ul>
      <li id="ctxEdit" tabindex="-1"><span class="icon">โ๏ธ</span>ุชุนุฏูู ุงููุณู</li>
      <li id="ctxDelete" tabindex="-1"><span class="icon">๐๏ธ</span>ุญุฐู ุงููุณู</li>
      <li id="ctxViewTeachers" tabindex="-1"><span class="icon">๐จโ๐ซ</span>ุนุฑุถ ุงููุฏุฑุณูู</li>
      <li id="ctxViewRooms" tabindex="-1"><span class="icon">๐ซ</span>ุนุฑุถ ุงููุงุนุงุช</li>
    </ul>
  </div>

  <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="themeToggle" aria-label="ุชุจุฏูู ุงููุถุน ุงููููู">
    <i>๐</i>
  </button>

  <script src="js/shared.js" defer></script>
  <script src="js/departments.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize department management
      const DepartmentManager = {
        // Constants
        DEFAULT_DEPARTMENTS: [
          { name: "ุนุงู", code: "GEN", color: "#34495e" },
          { name: "ุนููู ุงูุญุงุณุจ", code: "CS", color: "#3498db" },
          { name: "ุงูุฑูุงุถูุงุช", code: "MATH", color: "#e74c3c" },
          { name: "ุงูููุฒูุงุก", code: "PHYS", color: "#2ecc71" },
          { name: "ุงูููููุงุก", code: "CHEM", color: "#f39c12" }
        ],

        // DOM Elements
        elements: {
          colorInput: document.getElementById('deptColor'),
          colorPreview: document.getElementById('colorPreview'),
          addSampleBtn: document.getElementById('addSampleDepts'),
          yearSpan: document.getElementById('currentYear')
        },

        // Initialize the manager
        init() {
          this.setCurrentYear();
          this.initializeColorPicker();
          this.initializeSampleDepts();
          this.ensureGeneralDepartment();
        },

        // Set current year in footer
        setCurrentYear() {
          if (this.elements.yearSpan) {
            this.elements.yearSpan.textContent = new Date().getFullYear();
          }
        },

        // Initialize color picker functionality
        initializeColorPicker() {
          const { colorInput, colorPreview } = this.elements;
          if (colorInput && colorPreview) {
            colorInput.addEventListener('input', () => {
              colorPreview.style.backgroundColor = colorInput.value;
            });
          }
        },

        // Create a new department
        createDepartment(name, code, color) {
          return {
            id: SharedData.generateId(),
            name,
            code,
            color,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
        },

        // Add general department if it doesn't exist
        ensureGeneralDepartment() {
          if (!SharedData.departments || SharedData.departments.length === 0) {
            SharedData.departments = [
              this.createDepartment("ุนุงู", "GEN", "#34495e")
            ];
            this.saveAndReload();
          } else if (!SharedData.departments.some(d => d.code === "GEN")) {
            SharedData.departments.unshift(
              this.createDepartment("ุนุงู", "GEN", "#34495e")
            );
            this.saveAndReload();
          }
        },

        // Initialize sample departments
        initializeSampleDepts() {
          const { addSampleBtn } = this.elements;
          if (addSampleBtn) {
            addSampleBtn.addEventListener('click', () => this.handleSampleDepts());
          }
        },

        // Handle adding sample departments
        async handleSampleDepts() {
          try {
            const confirmed = await this.showConfirmDialog('ูู ุชุฑูุฏ ุฅุถุงูุฉ ุฃูุณุงู ูููุฐุฌูุฉ ููุจุฏุกุ');
            if (!confirmed) return;

            // Ensure general department exists first
            this.ensureGeneralDepartment();

            // Add other departments if they don't exist
            this.DEFAULT_DEPARTMENTS.forEach(dept => {
              if (!SharedData.departments.some(d => d.code === dept.code)) {
                SharedData.departments.push(
                  this.createDepartment(dept.name, dept.code, dept.color)
                );
              }
            });

            this.saveAndReload();
            this.showToast('ุชู ุฅุถุงูุฉ ุงูุฃูุณุงู ุงููููุฐุฌูุฉ ุจูุฌุงุญ', 'success');
          } catch (error) {
            console.error('Error adding sample departments:', error);
            this.showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุฃูุณุงู', 'error');
          }
        },

        // Show confirmation dialog
        showConfirmDialog(message) {
          return new Promise(resolve => {
            resolve(confirm(message));
          });
        },

        // Show toast notification
        showToast(message, type = 'info') {
          // Implement toast notification if available in shared.js
          if (window.showToast) {
            window.showToast(message, type);
          }
        },

        // Save changes and reload departments
        saveAndReload() {
          SharedData.saveToLocalStorage();
          if (window.departmentsManager) {
            window.departmentsManager.loadDepartments();
          }
        }
      };

      // Initialize the department manager
      DepartmentManager.init();
    });
  </script>
</body>
</html>